// ============================================
// DRIVYA.AI - Prisma Schema
// Outreach Intelligence Platform for NGOs, CSR, Incubators
// ============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum OrganizationType {
  NGO
  CSR
  INCUBATOR
  FOUNDATION
  CONSULTANCY
  GOVERNMENT
}

enum ComplianceType {
  FCRA
  TWELVE_A
  EIGHTY_G
  CSR_ELIGIBLE
  REGISTERED
  OTHER
}

enum VerificationStatus {
  UNVERIFIED
  PENDING
  VERIFIED
  REJECTED
}

enum FitScoreLevel {
  EXCELLENT
  GOOD
  MODERATE
  POOR
}

enum WorkspaceRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

// ============================================
// USER & WORKSPACE MODELS
// ============================================

model User {
  id              String    @id @default(cuid())
  email           String    @unique
  name            String?
  password        String? // Optional for OAuth users
  profileImage    String?
  bio             String?
  phoneNumber     String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  workspaces      WorkspaceMember[]
  savedLists      SavedList[]
  notes           Notes[]
  proposals       Proposal[]
  activities      ActivityLog[]

  @@index([email])
}

model Workspace {
  id              String    @id @default(cuid())
  name            String
  slug            String    @unique
  description     String?
  logo            String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  members         WorkspaceMember[]
  savedLists      SavedList[]
  notes           Notes[]
  proposals       Proposal[]
  activities      ActivityLog[]

  @@index([slug])
}

model WorkspaceMember {
  id              String    @id @default(cuid())
  userId          String
  workspaceId     String
  role            WorkspaceRole @default(MEMBER)
  joinedAt        DateTime  @default(now())
  
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace       Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([userId, workspaceId])
  @@index([userId])
  @@index([workspaceId])
}

// ============================================
// CORE ORGANIZATION MODELS
// ============================================

model Organization {
  id                  String    @id @default(cuid())
  name                String
  slug                String    @unique
  website             String?
  description         String?
  logoUrl             String?
  bannerUrl           String?
  type                OrganizationType
  registrationNumber  String?
  incorporationYear   Int?
  teamSize            Int?
  headquartersCity    String?
  headquartersState   String?
  headquartersCountry String? @default("India")
  
  // Auto-generated profile
  profileSummary      String? // LLM-generated summary
  profileScraped      Boolean @default(false)
  lastScrapedAt       DateTime?
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  // Relations
  focusAreas          OrganizationFocusArea[]
  contactPoints       ContactPoint[]
  ngoData             NGOData?
  csrData             CSRData?
  incubatorData       IncubatorData?
  verificationData    VerificationData?
  savedListItems      SavedListItem[]
  notes               Notes[]
  proposalsAsNGO      Proposal[] @relation("NGOProposal")
  proposalsAsCSR      Proposal[] @relation("CSRProposal")
  fitScoreCacheAsOrg1 FitScoreCache[] @relation("FitScoreCache_org1")
  fitScoreCacheAsOrg2 FitScoreCache[] @relation("FitScoreCache_org2")
  activityLogs        ActivityLog[]

  @@index([slug])
  @@index([type])
  @@index([headquartersCity])
}

model NGOData {
  id                  String    @id @default(cuid())
  organizationId      String    @unique
  registrar_12a       String?
  registrar_80g       String?
  fcra_number         String?
  fcra_validity_till  DateTime?
  audited_reports_url String?
  annual_revenue      BigInt? // In rupees
  beneficiaries       Int?
  programs            String? // JSON: array of program names
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  organization        Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([fcra_number])
}

model CSRData {
  id                  String    @id @default(cuid())
  organizationId      String    @unique
  csr_budget_annual   BigInt? // In rupees
  csr_budget_year     Int?
  csr_budget_link     String?
  focus_areas         String? // JSON: array of focus area IDs
  past_partners       String? // JSON: array of org IDs
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  organization        Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

model IncubatorData {
  id                  String    @id @default(cuid())
  organizationId      String    @unique
  focus_sectors       String? // JSON: array of sectors
  portfolio_size      Int?
  portfolio_exits     Int?
  funding_provided    BigInt? // In rupees
  website_link        String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  organization        Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

model ContactPoint {
  id                  String    @id @default(cuid())
  organizationId      String
  name                String
  title               String?
  email               String?
  phoneNumber         String?
  linkedinUrl         String?
  department          String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  organization        Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([email])
}

// ============================================
// FOCUS AREAS
// ============================================

model FocusArea {
  id              String    @id @default(cuid())
  name            String    @unique
  description     String?
  color           String? // For UI display
  icon            String? // Icon identifier
  displayOrder    Int?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  subFocusAreas   SubFocusArea[]
  organizations   OrganizationFocusArea[]

  @@index([name])
}

model SubFocusArea {
  id              String    @id @default(cuid())
  focusAreaId     String
  name            String
  description     String?
  displayOrder    Int?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  focusArea       FocusArea @relation(fields: [focusAreaId], references: [id], onDelete: Cascade)

  @@unique([focusAreaId, name])
  @@index([focusAreaId])
}

model OrganizationFocusArea {
  id              String    @id @default(cuid())
  organizationId  String
  focusAreaId     String
  isPrimary       Boolean @default(false) // Primary focus area
  yearsOfExperience Int?
  
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  focusArea       FocusArea @relation(fields: [focusAreaId], references: [id], onDelete: Cascade)

  @@unique([organizationId, focusAreaId])
  @@index([organizationId])
  @@index([focusAreaId])
}

// ============================================
// SAVED LISTS & NOTES (CRM-like)
// ============================================

model SavedList {
  id              String    @id @default(cuid())
  workspaceId     String
  userId          String
  name            String
  description     String?
  color           String?
  isPublic        Boolean @default(false)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  workspace       Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  items           SavedListItem[]

  @@index([workspaceId])
  @@index([userId])
}

model SavedListItem {
  id              String    @id @default(cuid())
  savedListId     String
  organizationId  String
  notes           String?
  addedAt         DateTime  @default(now())
  
  savedList       SavedList @relation(fields: [savedListId], references: [id], onDelete: Cascade)
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([savedListId, organizationId])
  @@index([savedListId])
  @@index([organizationId])
}

model Notes {
  id              String    @id @default(cuid())
  workspaceId     String
  userId          String
  organizationId  String
  title           String?
  content         String
  isPinned        Boolean @default(false)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  workspace       Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([userId])
  @@index([organizationId])
}

// ============================================
// FIT SCORE & MATCHING
// ============================================

model FitScoreCache {
  id              String    @id @default(cuid())
  organizationId1 String // NGO or Incubator
  organizationId2 String // CSR or Partner
  overallScore    Float // 0-100
  focusAreaMatch  Float
  geographyMatch  Float
  complianceMatch Float
  pastCollabMatch Float
  level           FitScoreLevel
  details         String? // JSON: detailed breakdown
  calculatedAt    DateTime  @default(now())
  expiresAt       DateTime // Re-calculate after this date
  
  organization1   Organization @relation("FitScoreCache_org1", fields: [organizationId1], references: [id], onDelete: Cascade)
  organization2   Organization @relation("FitScoreCache_org2", fields: [organizationId2], references: [id], onDelete: Cascade)

  @@unique([organizationId1, organizationId2])
  @@index([organizationId1])
  @@index([organizationId2])
  @@index([overallScore])
}

// ============================================
// VERIFICATION SYSTEM
// ============================================

model VerificationData {
  id              String    @id @default(cuid())
  organizationId  String    @unique
  status          VerificationStatus @default(UNVERIFIED)
  
  // Compliance certifications
  has_12a         Boolean?
  has_80g         Boolean?
  has_fcra        Boolean?
  is_csr_eligible Boolean?
  is_registered   Boolean?
  
  // Credibility indicators
  incorporation_year Int?
  years_active    Int?
  team_size       Int?
  audited_reports Boolean?
  
  // Directory checks
  niti_aayog       Boolean? // NGO Darpan
  guidestar        Boolean?
  credibility_score Float? // 0-100
  
  verificationNotes String?
  lastVerifiedAt  DateTime?
  verifiedBy      String? // User ID
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([status])
}

// ============================================
// OPPORTUNITIES & PROGRAMS
// ============================================

model Program {
  id              String    @id @default(cuid())
  name            String
  description     String?
  type            String // e.g., "CSR_CALL", "GRANT", "CHALLENGE"
  organizationId  String?
  focusAreas      String? // JSON: array of focus area IDs
  eligibility     String? // JSON: eligibility criteria
  deadline        DateTime?
  applicationUrl  String?
  fundingAmount   BigInt?
  budget_type     String? // e.g., "annual", "per_project"
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([type])
  @@index([deadline])
}

model Grant {
  id              String    @id @default(cuid())
  name            String
  description     String?
  fundingBody     String
  amount          BigInt? // In rupees
  deadline        DateTime?
  focusAreas      String? // JSON
  eligibility     String?
  applicationUrl  String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([fundingBody])
  @@index([deadline])
}

// ============================================
// PROPOSAL & OUTREACH ENGINE
// ============================================

model Proposal {
  id              String    @id @default(cuid())
  workspaceId     String
  userId          String
  ngoId           String // NGO seeking partnership
  csrId           String // CSR / Partner
  
  status          String @default("draft") // draft, sent, opened, responded, accepted, rejected
  subject         String?
  emailBody       String? // Generated outreach email
  proposalContent String? // Generated proposal sections
  
  fitScoreAt      DateTime?
  sentAt          DateTime?
  openedAt        DateTime?
  respondedAt     DateTime?
  
  customizations  String? // JSON: user modifications
  attachments     String? // JSON: file URLs
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  workspace       Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  ngo             Organization @relation("NGOProposal", fields: [ngoId], references: [id], onDelete: Cascade)
  csr             Organization @relation("CSRProposal", fields: [csrId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([userId])
  @@index([ngoId])
  @@index([csrId])
  @@index([status])
}

// ============================================
// ACTIVITY LOG
// ============================================

model ActivityLog {
  id              String    @id @default(cuid())
  workspaceId     String
  userId          String
  organizationId  String?
  action          String // e.g., "org_viewed", "list_created", "proposal_sent"
  description     String?
  metadata        String? // JSON
  
  createdAt       DateTime  @default(now())
  
  workspace       Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization    Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  @@index([workspaceId])
  @@index([userId])
  @@index([organizationId])
  @@index([action])
}
